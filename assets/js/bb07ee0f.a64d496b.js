"use strict";(self.webpackChunkshuvi_document=self.webpackChunkshuvi_document||[]).push([[3786],{9613:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return c}});var a=t(9496);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,l=function(e,n){if(null==e)return{};var t,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},k={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,l=e.mdxType,r=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=p(t),c=l,m=d["".concat(s,".").concat(c)]||d[c]||k[c]||r;return t?a.createElement(m,o(o({ref:n},u),{},{components:t})):a.createElement(m,o({ref:n},u))}));function c(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var r=t.length,o=new Array(r);o[0]=d;var i={};for(var s in n)hasOwnProperty.call(n,s)&&(i[s]=n[s]);i.originalType=e,i.mdxType="string"==typeof e?e:l,o[1]=i;for(var p=2;p<r;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},5703:function(e,n,t){t.r(n),t.d(n,{assets:function(){return u},contentTitle:function(){return s},default:function(){return c},frontMatter:function(){return i},metadata:function(){return p},toc:function(){return k}});var a=t(7813),l=t(7044),r=(t(9496),t(9613)),o=["components"],i={id:"plugins",title:"Plugins"},s=void 0,p={unversionedId:"api-reference/plugins",id:"api-reference/plugins",title:"Plugins",description:"Overview",source:"@site/docs/api-reference/plugins.md",sourceDirName:"api-reference",slug:"/api-reference/plugins",permalink:"/shuvijs.org/docs/api-reference/plugins",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/api-reference/plugins.md",tags:[],version:"current",frontMatter:{id:"plugins",title:"Plugins"},sidebar:"apiReferenceSidebar",previous:{title:"RuntimePlugin API",permalink:"/shuvijs.org/docs/api-reference/plugin/runtimePlugin-api"},next:{title:"Page Component",permalink:"/shuvijs.org/docs/api-reference/runtime/page-component"}},u={},k=[{value:"Overview",id:"overview",level:2},{value:"Hook",id:"hook",level:2},{value:"SyncHook",id:"synchook",level:3},{value:"SyncBailHook",id:"syncbailhook",level:3},{value:"SyncWaterfallHook",id:"syncwaterfallhook",level:3},{value:"AsyncParallelHook",id:"asyncparallelhook",level:3},{value:"AsyncSeriesWaterfallHook",id:"asyncserieswaterfallhook",level:3},{value:"HookManager",id:"hookmanager",level:2},{value:"Overview",id:"overview-1",level:3},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Context",id:"context",level:3},{value:"Extending Hooks",id:"extending-hooks",level:3},{value:"corePlugin",id:"coreplugin",level:2},{value:"ICorePluginContext",id:"icoreplugincontext",level:3},{value:"afterInit",id:"afterinit",level:3},{value:"afterBuild",id:"afterbuild",level:3},{value:"afterDestroy",id:"afterdestroy",level:3},{value:"afterBundlerDone",id:"afterbundlerdone",level:3},{value:"afterBundlerTargetDone",id:"afterbundlertargetdone",level:3},{value:"configWebpack",id:"configwebpack",level:3},{value:"addExtraTarget",id:"addextratarget",level:3},{value:"addResource",id:"addresource",level:3},{value:"addRuntimeFile",id:"addruntimefile",level:3},{value:"addRuntimeService",id:"addruntimeservice",level:3},{value:"serverPlugin",id:"serverplugin",level:2},{value:"onListen",id:"onlisten",level:3},{value:"addProxy",id:"addproxy",level:3},{value:"addMiddleware",id:"addmiddleware",level:3},{value:"runtimePlugin",id:"runtimeplugin",level:2}],d={toc:k};function c(e){var n=e.components,t=(0,l.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"Shuvi has 3 types of plugin which are corePlugin, serverPlugin and runtimePlugin."),(0,r.kt)("p",null,"Each plugin consists of a series of hooks."),(0,r.kt)("h2",{id:"hook"},"Hook"),(0,r.kt)("p",null,"The basic unit of plugin."),(0,r.kt)("p",null,"There are 5 types of hook. Each of them is an pipline that constrains how a series of hook handlers work."),(0,r.kt)("p",null,"More detailed, every hook has a ",(0,r.kt)("inlineCode",{parentName:"p"},"use")," and a ",(0,r.kt)("inlineCode",{parentName:"p"},"run")," method. The outside hook logic could be describe as a hook handler and could be added by ",(0,r.kt)("inlineCode",{parentName:"p"},"use")," method."),(0,r.kt)("p",null,"After adding hook handlers, hook could be called to run these hook logic through ",(0,r.kt)("inlineCode",{parentName:"p"},"run")," method and get the result."),(0,r.kt)("p",null,"The following is an easiest example of ",(0,r.kt)("inlineCode",{parentName:"p"},"SyncHook"),"."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="easiest-example.ts"',title:'"easiest-example.ts"'},"import { createSyncHook } from '@shuvi/hook'\nconst hook = createSyncHook<void>();\nhook.use(() => {\n  console.log(1)\n})\nhook.use(() => {\n  console.log(2)\n})\nhook.run()\n// will log 1\n// will log 2\n")),(0,r.kt)("p",null,"Generally, every hook conceptually has 3 values: ",(0,r.kt)("inlineCode",{parentName:"p"},"initialValue"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"extraArg")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"returnValue"),". For a hook handler, ",(0,r.kt)("inlineCode",{parentName:"p"},"initialValue")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"extraArg")," are first 2 parameters and ",(0,r.kt)("inlineCode",{parentName:"p"},"returnValue")," is the return value. The ",(0,r.kt)("inlineCode",{parentName:"p"},"extraArg")," is an assistant parameter. When a hook runs, ",(0,r.kt)("inlineCode",{parentName:"p"},"initialValue")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"extraArg")," shoule be passed as parameters. And ",(0,r.kt)("inlineCode",{parentName:"p"},"returnValue")," will be processed according to the type of hook."),(0,r.kt)("p",null,"In the following example, a ",(0,r.kt)("inlineCode",{parentName:"p"},"SyncHook")," that ",(0,r.kt)("inlineCode",{parentName:"p"},"initialValue"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"extraArg")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"returnValue")," are all number type is defined. When this hook runs, each of return value of the handlers is collected as an array to be the final result."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="3-value-example.ts"',title:'"3-value-example.ts"'},"import { createSyncHook } from '@shuvi/hook'\nconst hook = createSyncHook<number, number, number>();\nhook.use((initialValue, extraArg) => {\n  return initialValue + extraArg\n})\nhook.use((initialValue, extraArg) => {\n  return initialValue + extraArg + 1\n})\nconst result = hook.run(1, 2)\nconsole.log(result)\n// log [3, 4]\n")),(0,r.kt)("h3",{id:"synchook"},"SyncHook"),(0,r.kt)("p",null,"The easiest hook. Every hook handler should be sync function. When a ",(0,r.kt)("inlineCode",{parentName:"p"},"SyncHook")," runs, every hook handler will be executed in turn and each of return value of the handlers is collected as an array to be the result."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hook type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"SyncHook<I = void, E = void, R = void>\n"))),(0,r.kt)("li",{parentName:"ul"},"handler type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => R>\n"))),(0,r.kt)("li",{parentName:"ul"},"runner type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => R[]>\n")),(0,r.kt)("div",{parentName:"li",className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"About ",(0,r.kt)("inlineCode",{parentName:"h5"},"Remove Void Parameters"))),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"The type ",(0,r.kt)("inlineCode",{parentName:"p"},"RemoveVoidParameters")," will remove void parameters of the passed-in type to optimize TypeScript writing experience."))))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="SyncHook-example.ts"',title:'"SyncHook-example.ts"'},"import { createSyncHook } from '@shuvi/hook'\nconst hook1 = createSyncHook<number, number, number>();\nconst hook2 = createSyncHook<number, void>();\n\nhook1.use((i, e) => {\n  return i + e + 1\n})\nhook1.use((i, e) => {\n  return i + e + 2\n})\nconst result = hook1.run(1, 2)\n// result will be [4, 5]\n\nhook2.use((i) => {\n  console.log(i + 1)\n})\nhook2.use((i) => {\n  console.log(i + 2)\n})\nhook2.run(1)\n// log 2\n// log 3\n")),(0,r.kt)("h3",{id:"syncbailhook"},"SyncBailHook"),(0,r.kt)("p",null,"When a syncBailHook runs, every hook handler will be executed in turn. If a hook handler returns a non-undefined value, the process will abort and the return value will be the result of the hook."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hook type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"SyncBailHook<I = void, E = void, R = I>\n"))),(0,r.kt)("li",{parentName:"ul"},"handler type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => R | void | undefined>\n"))),(0,r.kt)("li",{parentName:"ul"},"runner type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => R | void | undefined>\n")))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="SyncBailHook-example.ts"',title:'"SyncBailHook-example.ts"'},"import { createSyncHook } from '@shuvi/hook'\nconst hook = createSyncBailHook<number, void>();\nhook.use((i) => {\n  // do not return\n  console.log('1st handler')\n})\nhook.use((i, e) => {\n  console.log('2nd handler')\n  return i + 1\n})\nhook.use((i) => {\n  // do not return\n  console.log('3rd handler')\n})\nconst result = hook.run(1)\n// log '1st handler'\n// log '2nd handler'\n// result will be 2\n")),(0,r.kt)("h3",{id:"syncwaterfallhook"},"SyncWaterfallHook"),(0,r.kt)("p",null,"When a ",(0,r.kt)("inlineCode",{parentName:"p"},"SyncWaterfallHook")," runs, every hook handler will be executed in turn. The type of ",(0,r.kt)("inlineCode",{parentName:"p"},"initialValue")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"returnValue")," are the same. The return value of the previous hook handler will be the initial value of the next hook handler. And the return value of the last hook handler will be the result of the hook."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hook type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"SyncWaterfallHook<I, E = void>\n"))),(0,r.kt)("li",{parentName:"ul"},"handler type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => I>\n"))),(0,r.kt)("li",{parentName:"ul"},"runner type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => I>\n")))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="SyncWaterfallHook-example.ts"',title:'"SyncWaterfallHook-example.ts"'},"import { createSyncWaterfallHook } from '@shuvi/hook'\nconst hook = createSyncWaterfallHook<number, void>();\nhook.use((i) => i + 1)\nhook.use((i) => i + 2)\nhook.use((i) => i + 3)\n\nconst result = hook.run(1)\n// result will be 7\n")),(0,r.kt)("h3",{id:"asyncparallelhook"},"AsyncParallelHook"),(0,r.kt)("p",null,"Almost same as ",(0,r.kt)("inlineCode",{parentName:"p"},"SyncHook"),", but hook handler could be async function. When the hook runs, each of return value of the async handlers is collected as an array to be the result."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hook type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"AsyncParallelHook<I = void, E = void, R = void>\n"))),(0,r.kt)("li",{parentName:"ul"},"handler type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => R | Promise<R>>\n"))),(0,r.kt)("li",{parentName:"ul"},"runner type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => Promise<R[]>>\n")))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="AsyncParallelHook-example.ts"',title:'"AsyncParallelHook-example.ts"'},"import { createSyncHook } from '@shuvi/hook'\nconst hook1 = createAsyncParallelHook<number, number, number>();\nconst hook2 = createAsyncParallelHook<number, void>();\n\nhook1.use(async (i, e) => {\n  return i + e + 1\n})\nhook1.use((i, e) => {\n  return i + e + 2\n})\nconst result = await hook1.run(1, 2)\n// result will be [4, 5]\n\nhook2.use(async (i) => {\n  console.log(i + 1)\n})\nhook2.use((i) => {\n  console.log(i + 2)\n})\nawait hook2.run(1)\n// log 2\n// log 3\n")),(0,r.kt)("h3",{id:"asyncserieswaterfallhook"},"AsyncSeriesWaterfallHook"),(0,r.kt)("p",null,"Almost same as ",(0,r.kt)("inlineCode",{parentName:"p"},"SyncWaterfallHook"),", but hook handler could be async function."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hook type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"AsyncSeriesWaterfallHook<I, E = void>\n"))),(0,r.kt)("li",{parentName:"ul"},"handler type: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => I | Promise<I>>\n"))),(0,r.kt)("li",{parentName:"ul"},"runner type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"RemoveVoidParameters<(initalValue: I, extraArg: E) => Promise<I>>\n")))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="AsyncWaterfallHook-example.ts"',title:'"AsyncWaterfallHook-example.ts"'},"import { createAsyncWaterfallHook } from '@shuvi/hook'\nconst hook = createAsyncWaterfallHook<number, void>();\nhook.use((i) => i + 1)\nhook.use(async (i) => i + 2)\nhook.use((i) => i + 3)\n\nconst result = await hook.run(1)\n// result will be 7\n")),(0,r.kt)("h2",{id:"hookmanager"},"HookManager"),(0,r.kt)("h3",{id:"overview-1"},"Overview"),(0,r.kt)("p",null,"Hook manager can manage a series of hooks and provide more functions such as setting context and extending hooks. In this way, a plugin mechanism can be established based on the hook manager."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"HookManager")," instance type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type HookManager<HM extends HookMap, C, EHM extends HookMap> = {\n  createPlugin: (\n    pluginHandlers: IPluginHandlers<HM & EHM, C> & {\n      setup?: Setup<EHM>;\n    },\n    options?: PluginOptions\n  ) => IPluginInstance<HM & EHM, C>;\n  usePlugin: (...plugins: IPluginInstance<HM & EHM, C>[]) => void;\n  runner: RunnerType<HM, EHM>;\n  setContext: (context: C) => void;\n  clear: () => void;\n  addHooks: (hook: Partial<EHM>) => void;\n  hooks: HM | (HM & EHM);\n  getPlugins: () => IPluginInstance<HM & EHM, C>[];\n};\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"createHookManager")," type:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"<HM extends HookMap, C = void, EHM extends HookMap = {}>(\n  hookMap: HM, \n  hasContext: boolean = true\n) => HookManager<HM, C, EHM>\n")))),(0,r.kt)("p",null,"The function ",(0,r.kt)("inlineCode",{parentName:"p"},"createHookManager")," receives a hookMap which is an object containing a series of hooks, and returns a ",(0,r.kt)("inlineCode",{parentName:"p"},"HookManager")," instance."),(0,r.kt)("p",null,"A single hook can ",(0,r.kt)("inlineCode",{parentName:"p"},"use")," hook handlers and ",(0,r.kt)("inlineCode",{parentName:"p"},"run")," to get result. A hook manger can also use collections of handlers of various hooks by ",(0,r.kt)("inlineCode",{parentName:"p"},"usePlugin"),", and run each hook to get result by ",(0,r.kt)("inlineCode",{parentName:"p"},"runner[hookName]"),"."),(0,r.kt)("p",null,"And the ",(0,r.kt)("inlineCode",{parentName:"p"},"collections of handlers of various hooks"),", is the so-called plugin."),(0,r.kt)("h3",{id:"basic-usage"},"Basic Usage"),(0,r.kt)("p",null,"The following is an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const hook1 = createSyncHook<void>();\nconst hook2 = createSyncHook<number>()\nconst hooks = { hook1, hook2 };\n\nconst manager = createHookManager<typeof hooks, Context>(hooks);\nconst { createPlugin, setContext, usePlugin, runner } = group;\n\nlet number = 1;\nconst plugin1 = createPlugin({\n  hook1: () => {\n    number++\n  },\n  hook2: (i) => {\n    console.log(i + 1)\n  }\n})\n\nconst plugin2 = createPlugin({\n  hook1: () => {\n    number++\n  },\n  hook2: (i) => {\n    console.log(i + 2)\n  }\n})\n\nusePlugin(plugin1, plugin2);\nrunner.hook1();\nconsole.log(number)\n// log 3\nrunner.hook2(1);\n// log 2\n// log 3\n")),(0,r.kt)("p",null,"In this example, a plugin can be created by ",(0,r.kt)("inlineCode",{parentName:"p"},"createPlugin")," method, and can be applied by ",(0,r.kt)("inlineCode",{parentName:"p"},"usePlugin")," method."),(0,r.kt)("p",null,"Specific hook can be executed by corresponding property of the ",(0,r.kt)("inlineCode",{parentName:"p"},"runner"),". All plugins will be initialized as the first time ",(0,r.kt)("inlineCode",{parentName:"p"},"runner")," is executed."),(0,r.kt)("h3",{id:"context"},"Context"),(0,r.kt)("p",null,"Hook manager introduces an important concept, the context, which must be set before any ",(0,r.kt)("inlineCode",{parentName:"p"},"runner")," being executed and can be visit as the last parameter of the hook handler."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const hook = createSyncHook<number>()\nconst hooks = { hook };\n\ntype Context = {\n  hello: number\n}\n\nconst manager = createHookManager<typeof hooks, Context>(hooks);\nconst { createPlugin, setContext, usePlugin, runner } = group;\n\nlet number = 1;\nconst plugin2 = createPlugin({\n  hook: (i, context) => {\n    console.log(i + context.hello + 1)\n  }\n})\n\nusePlugin(plugin1, plugin2);\nsetContext({ hello: 1 });\nrunner.hook2(1);\n// log 3\n")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"About ",(0,r.kt)("inlineCode",{parentName:"h5"},"Remove Void Parameters"))),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"As well as single hooks, the type ",(0,r.kt)("inlineCode",{parentName:"p"},"RemoveVoidParameters")," will remove void parameters in the handlers of ",(0,r.kt)("inlineCode",{parentName:"p"},"hookManager"),", including the ",(0,r.kt)("inlineCode",{parentName:"p"},"context")," parameter."))),(0,r.kt)("h3",{id:"extending-hooks"},"Extending Hooks"),(0,r.kt)("p",null,"hooks can be extended by ",(0,r.kt)("inlineCode",{parentName:"p"},"addHooks")," method which can be visited through ",(0,r.kt)("inlineCode",{parentName:"p"},"setup")," method in the first parameter of ",(0,r.kt)("inlineCode",{parentName:"p"},"createPlugin"),". In this way, system functions can also be extended in plugins."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let hookNumber = 0;\nlet extraHookNumber = 1;\nconst hook = createSyncHook<number>();\nconst extraHook = createSyncHook<number>();\n\nconst baseHooks = { hook };\nconst extraHooks = { extraHook };\n\nconst group = createHookManager<typeof baseHooks, void, typeof extraHooks>(\n  baseHooks,\n  false\n);\nconst { createPlugin, usePlugin, runner, addHooks } = group;\nconst plugin = createPlugin({\n  setup: ({ addHooks } => {\n    addHooks(extraHooks)\n  })\n  hook: (i) => {\n    hookNumber += i;\n  },\n  extraHook: (i) => {\n    extraHookNumber *= i;\n  }\n});\nrunner.hook(1)\nconsole.log(hookNumber)\n// log 1\nrunner.extraHook(2)\nconsole.log(extraHookNumber)\n// log 2\n")),(0,r.kt)("h2",{id:"coreplugin"},"corePlugin"),(0,r.kt)("h3",{id:"icoreplugincontext"},"ICorePluginContext"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type IPluginContext = {\n  mode: 'development' | 'production';\n  paths: IPaths;\n  config: Config;\n  phase: IPhase;\n  pluginRunner: PluginRunner;\n  assetPublicPath: string;\n  resolveAppFile(...paths: string[]): string;\n  resolveUserFile(...paths: string[]): string;\n  resolveBuildFile(...paths: string[]): string;\n  resolvePublicFile(...paths: string[]): string;\n  getAssetPublicUrl(...paths: string[]): string;\n};\n\ninterface IPaths {\n  rootDir: string;\n  buildDir: string;\n  // dir to store shuvi's artifacts\n  privateDir: string;\n  // dir to store shuvi generated src files\n  appDir: string;\n  // dir to runtime libraries\n  runtimeDir: string;\n  //resources file\n  resources: string;\n  // user src dir\n  srcDir: string;\n  // functional dirs\n  pagesDir: string;\n  // api dirs\n  apisDir: string;\n  publicDir: string;\n}\n\ntype IPhase =\n  | 'PHASE_PRODUCTION_BUILD'\n  | 'PHASE_PRODUCTION_SERVER'\n  | 'PHASE_DEVELOPMENT_SERVER'\n  | 'PHASE_INSPECT_WEBPACK';\n\n")),(0,r.kt)("h3",{id:"afterinit"},"afterInit"),(0,r.kt)("p",null,"will be executed after internal api initializes."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void"))),(0,r.kt)("h3",{id:"afterbuild"},"afterBuild"),(0,r.kt)("p",null,"will be executed after ",(0,r.kt)("inlineCode",{parentName:"p"},"shuvi build")," is done."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"})),(0,r.kt)("h3",{id:"afterdestroy"},"afterDestroy"),(0,r.kt)("p",null,"will be executed after shuvi process ends."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void"))),(0,r.kt)("h3",{id:"afterbundlerdone"},"afterBundlerDone"),(0,r.kt)("p",null,"will be executed after all webpack bundler target are done."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"BundlerDoneExtra"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type BundlerDoneExtra = {\n  first: boolean;\n  stats: webpack.MultiStats;\n};\n"))),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void"))),(0,r.kt)("h3",{id:"afterbundlertargetdone"},"afterBundlerTargetDone"),(0,r.kt)("p",null,"will be executed after each webpack bundler target is done."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"BundlerTargetDoneExtra"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type BundlerTargetDoneExtra = {\n  first: boolean;\n  name: string;\n  stats: webpack.Stats;\n};\n"))),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void"))),(0,r.kt)("h3",{id:"configwebpack"},"configWebpack"),(0,r.kt)("p",null,"will be executed at bundler initializing to config each of webpack bundler targets"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"p"},"AsyncSeriesWaterfallHook"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"p"},"WebpackChain"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"p"},"ConfigWebpackAssistant")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type ConfigWebpackAssistant = {\n  name: string;\n  mode: 'development' | 'production';\n  webpack: Webpack;\n  helpers: {\n    addExternals: (chain: WebpackChain, externalsFn: ExternalsFunction) => void;\n  };\n};\n\ntype ExternalsFunction = (\n  data: { context: string; request: string },\n  callback: (err: Error | null, result: string | undefined) => void\n) => void;\n")))),(0,r.kt)("h3",{id:"addextratarget"},"addExtraTarget"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"p"},"AsyncParallelHook"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"p"},"ExtraTargetAssistant")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type ExtraTargetAssistant = {\n  createConfig(options: IWebpackConfigOptions): WebpackChain;\n  mode: 'development' | 'production';\n  webpack: Webpack;\n};\n\ninterface IWebpackConfigOptions {\n  name: string;\n  node: boolean;\n  entry: {\n    [x: string]: string | string[];\n  };\n  include?: string[];\n  outputDir: string;\n  webpackHelpers: {\n    addExternals: (chain: WebpackChain, externalsFn: ExternalsFunction) => void;\n  };;\n}\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"p"},"void"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"returnType: ",(0,r.kt)("inlineCode",{parentName:"p"},"Target")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"interface Target {\n  name: string;\n  chain: WebpackChain;\n}\n")))),(0,r.kt)("h3",{id:"addresource"},"addResource"),(0,r.kt)("p",null,"to add runtime resources."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"returnType: ",(0,r.kt)("inlineCode",{parentName:"li"},"Resources | Resources[]"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type Resources = [string, string | undefined]\n")))),(0,r.kt)("h3",{id:"addruntimefile"},"addRuntimeFile"),(0,r.kt)("p",null,"to add runtime files before bundler starts."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"p"},"AsyncParallelHook"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"p"},"void"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"p"},"AddRuntimeFileUtils")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type AddRuntimeFileUtils = {\n  createFile: (options: CreateFileOption) => FileOptions;\n  getAllFiles: (dependencies: string | string[]) => string[];\n};\n\ntype CreateFileOption = {\n  name: string;\n  content: () => string;\n  dependencies?: string | string[];\n};\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"returnType: ",(0,r.kt)("inlineCode",{parentName:"p"},"FileOptions | FileOptions[]")))),(0,r.kt)("h3",{id:"addruntimeservice"},"addRuntimeService"),(0,r.kt)("p",null,"to add runtime services for user"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"returnType: ",(0,r.kt)("inlineCode",{parentName:"li"},"RuntimeService | RuntimeService[]"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type RuntimeService = {\n  source: string;\n  exported: string;\n  filepath?: string;\n};\n")))),(0,r.kt)("h2",{id:"serverplugin"},"serverPlugin"),(0,r.kt)("h3",{id:"onlisten"},"onListen"),(0,r.kt)("p",null,"will executed on server listening."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"{ port: number; hostname?: string }")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"returnType: ",(0,r.kt)("inlineCode",{parentName:"li"},"void"))),(0,r.kt)("h3",{id:"addproxy"},"addProxy"),(0,r.kt)("p",null,"add local api proxy, usually works at development mode."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"hookType: ",(0,r.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,r.kt)("li",{parentName:"ul"},"initialValue: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"extraArg: ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},"returnType: ",(0,r.kt)("inlineCode",{parentName:"li"},"IProxy"))),(0,r.kt)("h3",{id:"addmiddleware"},"addMiddleware"),(0,r.kt)("h2",{id:"runtimeplugin"},"runtimePlugin"),(0,r.kt)("h3",{id:""}))}c.isMDXComponent=!0}}]);